<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chinees Poepen — Scorekeeper (v6)</title>
  <style>
    :root{--bg:#f6f8fa;--card:#fff;--line:#e5e7eb;--text:#111;--muted:#6b7280;--accent:#0d6efd;--ok:#198754;--bad:#dc3545;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:8px;align-items:center}
    h1{margin:0;font-size:18px}
    #jsStatus{margin-left:auto;font-size:12px;color:var(--muted)}
    main{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    textarea,input{width:100%;padding:10px 12px;border:1px solid #d0d7de;border-radius:8px;font-size:16px;background:#fff}
    input[type=number]{-moz-appearance:textfield}
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    button{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-size:16px;background:var(--accent);color:#fff;cursor:pointer}
    button.secondary{background:#eef2f7;color:#111}
    button.ok{background:var(--ok)}
    button.bad{background:var(--bad)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff}
    .footer-space{height:40px}
    .columns{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .colCard{border:1px solid var(--line);border-radius:10px;padding:12px;background:#fff}
    .big{font-size:28px;font-weight:700}
    .list{margin-top:8px;max-height:220px;overflow:auto;border-top:1px dashed var(--line);padding-top:6px}
    .list div{font-size:13px;color:#333}
    .hint{font-size:12px;color:#555;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>Chinees Poepen — Scorekeeper</h1>
    <div id="jsStatus">JS init…</div>
  </header>
  <main>
    <!-- STEP 1 -->
    <section id="step1" class="card">
      <h2 style="margin:0 0 8px">Stap 1 — Spelers ingeven</h2>
      <p class="muted">Zet <strong>1 naam per regel</strong> (minstens 2 spelers).</p>
      <textarea id="playersInput" rows="6" placeholder="vb.&#10;Anna&#10;Bram&#10;Cem"></textarea>
      <div id="namesError" class="hint" style="display:none;color:#dc3545">Minstens 2 spelers nodig.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px">
        <button id="toStep2">Verder naar Stap 2</button>
        <button id="loadBtn" class="secondary">Vorige sessie laden</button>
      </div>
      <p class="muted" style="margin-top:8px">Tip: open dit bestand in <strong>Safari/Chrome</strong>. In een reader-app werkt de knop niet.</p>
      <div class="hint" id="debug1"></div>
    </section>

    <!-- STEP 2 -->
    <section id="step2" class="card" style="display:none">
      <div class="row" style="align-items:baseline">
        <div>
          <h2 style="margin:0 0 4px">Stap 2 — Biedingen</h2>
          <div class="muted">Ronde <span id="roundNo">1</span>/<span id="roundTotal">12</span> • <span class="pill"><span id="cardsThisRound">2</span> kaarten</span></div>
          <div class="muted" style="margin-top:6px">Vaste reeks: 2,3,4,5,6,7,7,6,5,4,3,2</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Biedingen per speler</h3>
        <div id="bids" class="grid"></div>
        <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:8px">
          <button id="toStep3" class="ok">Verder naar Stap 3 (biedingen vastzetten)</button>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section id="step3" class="card" style="display:none">
      <h2 style="margin:0 0 8px">Stap 3 — Effectieve slagen &amp; score</h2>
      <p class="muted">Bekijk eerst de biedingen (informatief) en vul daarna de <em>daadwerkelijke</em> slagen in.</p>
      <div id="bidsInfo" class="card" style="background:#fcfcfd"></div>
      <div id="results" class="grid" style="margin-top:12px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="applyScore" class="ok">Score toepassen</button>
        <button id="backToStep2" class="secondary">Terug naar biedingen</button>
      </div>
    </section>

    <!-- SCOREBOARD + HISTORY -->
    <section class="card" id="scoreArea" style="display:none">
      <h2 style="margin:0 0 8px">Scorebord</h2>
      <div id="scoreboard" class="columns"></div>
      <h3 style="margin:16px 0 8px">Historiek</h3>
      <div id="history" class="muted" style="border:1px dashed var(--line);border-radius:8px;padding:8px;max-height:220px;overflow:auto"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="nextRound" class="ok" style="display:none">Volgende ronde</button>
        <button id="exportBtn" class="secondary">Exporteer JSON</button>
        <button id="resetBtn" class="bad">Nieuw spel</button>
      </div>
    </section>

    <div class="footer-space"></div>
  </main>

<script>
(function(){
  const jsStatus = document.getElementById('jsStatus');
  jsStatus.textContent = 'JS actief ✔️';

  const FIXED_ROUNDS = [2,3,4,5,6,7,7,6,5,4,3,2];
  const state = { players: [], rounds: FIXED_ROUNDS.slice(), current: 0, bids: {}, results: {}, scores: {}, points: {} };

  const $ = (id)=>document.getElementById(id);
  const save = ()=>{ try{ localStorage.setItem('chinees_poepen_v6', JSON.stringify(state)); }catch(e){} };
  const load = ()=>{ try{ const raw = localStorage.getItem('chinees_poepen_v6'); if(!raw){alert('Geen opgeslagen spel'); return;} Object.assign(state, JSON.parse(raw)); $('step1').style.display='none'; $('step2').style.display='block'; $('scoreArea').style.display='block'; renderAll(); }catch(e){ alert('Kon niet laden'); } };
  const resetAll = ()=>{ try{ localStorage.removeItem('chinees_poepen_v6'); }catch(e){} location.reload(); };

  $('toStep2').addEventListener('click', () => {
    const names = $('playersInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
    $('debug1').textContent = 'Ingevoerde namen: ' + names.join(', ');
    if(names.length < 2){ $('namesError').style.display = 'block'; return; }
    $('namesError').style.display = 'none';
    state.players = names;
    state.scores = Object.fromEntries(names.map(n=>[n,0]));
    save();
    $('step1').style.display='none';
    $('step2').style.display='block';
    $('scoreArea').style.display='block';
    renderAll();
  });
  $('loadBtn').addEventListener('click', load);

  function renderStep2(){
    $('roundNo').textContent = state.current+1;
    $('roundTotal').textContent = state.rounds.length;
    const cards = state.rounds[state.current];
    $('cardsThisRound').textContent = cards;

    const wrap = $('bids');
    wrap.innerHTML = '';
    const existing = state.bids[state.current] || {};
    for(const p of state.players){
      const val = (existing[p] ?? '');
      const box = document.createElement('div');
      box.innerHTML = `<label>${p} — Bieding</label><input class="bid" type="number" min="0" max="${cards}" value="${val}" data-player="${p}" />`;
      wrap.appendChild(box);
    }

    $('toStep3').onclick = () => {
      const inputs = wrap.querySelectorAll('.bid');
      const bids = {};
      for(const inp of inputs){
        const v = parseInt(inp.value,10);
        if(isNaN(v) || v<0 || v>cards){ alert('Ongeldige bieding bij '+inp.dataset.player); return; }
        bids[inp.dataset.player] = v;
      }
      state.bids[state.current] = bids;
      save();
      $('step2').style.display='none';
      $('step3').style.display='block';
      renderStep3();
    };
  }

  function renderStep3(){
    const cards = state.rounds[state.current];
    const b = state.bids[state.current] || {};
    $('bidsInfo').innerHTML = `<strong>Biedingen (Ronde ${state.current+1}, ${cards} kaarten):</strong><div class="muted">${state.players.map(p => p+': '+(b[p]??'-')).join(' · ')}</div>`;

    const wrap = $('results');
    wrap.innerHTML = '';
    const existing = state.results[state.current] || {};
    for(const p of state.players){
      const val = (existing[p] ?? '');
      const box = document.createElement('div');
      box.innerHTML = `<label>${p} — Effectieve slagen</label><input class="res" type="number" min="0" max="${cards}" value="${val}" data-player="${p}" />`;
      wrap.appendChild(box);
    }

    $('applyScore').onclick = () => {
      const inputs = wrap.querySelectorAll('.res');
      const results = {};
      for(const inp of inputs){
        const v = parseInt(inp.value,10);
        if(isNaN(v)||v<0||v>cards){ alert('Ongeldig resultaat bij '+inp.dataset.player); return; }
        results[inp.dataset.player] = v;
      }
      state.results[state.current] = results;

      const bids = state.bids[state.current] || {};
      const r = state.current;
      state.points[r] = state.points[r] || {};
      for(const p of state.players){
        const bid = bids[p]??0, got=results[p]??0;
        const pts = (bid===got)?10:-bid;
        state.points[r][p]=pts;
        state.scores[p]=(state.scores[p]||0)+pts;
      }
      save();
      renderScoreboard(); renderHistory();
      $('nextRound').style.display=(state.current<state.rounds.length-1)?'inline-block':'none';
      alert('Score toegepast.');
    };

    $('backToStep2').onclick=()=>{ $('step3').style.display='none'; $('step2').style.display='block'; };
  }

  function renderScoreboard(){
    const container=$('scoreboard'); container.innerHTML='';
    for(const p of state.players){
      const total=state.scores[p]||0;
      const list=[]; for(let r=0;r<state.rounds.length;r++){ const pts=state.points[r]?.[p]; if(pts!==undefined) list.push(`<div>R${r+1}: ${pts>0?'+':''}${pts}</div>`); }
      const card=document.createElement('div'); card.className='colCard';
      card.innerHTML=`<div style="font-weight:600">${p}</div><div class="big">${total}</div><div class="list">${list.join('')||'<div class="muted">Nog geen scores</div>'}</div>`;
      container.appendChild(card);
    }
  }

  function renderHistory(){
    const out=[]; for(let r=0;r<state.rounds.length;r++){ if(!state.bids[r]&&!state.results[r])continue;
      const cards=state.rounds[r];
      out.push(`<div><strong>Ronde ${r+1}</strong> • ${cards} kaarten</div>`);
      if(state.bids[r]) out.push(`<div class="muted">Biedingen: ${Object.entries(state.bids[r]).map(([p,v])=>p+':'+v).join(' · ')}</div>`);
      if(state.results[r]) out.push(`<div class="muted">Resultaat: ${Object.entries(state.results[r]).map(([p,v])=>p+':'+v).join(' · ')}</div>`);
      if(state.points[r]) out.push(`<div class="muted">Punten: ${Object.entries(state.points[r]).map(([p,v])=>p+':' + (v>0?'+':'')+v).join(' · ')}</div>`);
      out.push('<hr>');
    }
    $('history').innerHTML=out.join('');
  }

  $('nextRound').addEventListener('click', ()=>{ if(state.current>=state.rounds.length-1){alert('Spel afgelopen!');return;} state.current++; save(); $('step3').style.display='none'; $('step2').style.display='block'; renderAll(); });
  $('exportBtn').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download='chinees_poepen_export.json';a.click();URL.revokeObjectURL(url); });
  $('resetBtn').addEventListener('click', ()=>{ if(confirm('Nieuw spel starten?')) resetAll(); });

  function renderAll(){ renderStep2(); renderScoreboard(); renderHistory(); }
  renderScoreboard();
})();
</script>
</body>
</html>
